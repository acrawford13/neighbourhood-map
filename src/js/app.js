var centers = [{
  id: 0,
  name: "Blk 20 Ghim Moh Road",
  location: {lat: 1.310996273116824, lng: 103.7882306571446}
},
{
  id: 1,
  name: "People's Park Food Centre",
  location: {lat: 1.284991021696262, lng: 103.842578750107}
},
{
  id: 2,
  name: "Tiong Bahru Market",
  location: {lat: 1.28508825756946, lng: 103.8323487853339}
},
{
  id: 3,
  name: "Blk 84 Marine Parade Central",
  location: {lat: 1.30228513841925, lng: 103.9063385261574}
},
{
  id: 4,
  name: "Chinatown Market",
  location: {lat: 1.282235148265126, lng: 103.8431776162956}
},
{
  id: 5,
  name: "Chomp Chomp Food Centre",
  location: {lat: 1.364228523158847, lng: 103.8665361302989}
},
{
  id: 6,
  name: "Dunman Food Centre",
  location: {lat: 1.309414187312779, lng: 103.9018251472102}
},
{
  id: 7,
  name: "East Coast Lagoon Food Village",
  location: {lat: 1.306684318209295, lng: 103.9350167472495}
},
{
  id: 8,
  name: "Blk 208B New Upper Changi Road",
  location: {lat: 1.324738844511069, lng: 103.9305604782304}
},
{
  id: 9,
  name: "Blk 210 Toa Payoh Lorong 8",
  location: {lat: 1.340260834959097, lng: 103.8543952792143}
},
{
  id: 10,
  name: "Blk 22 Toa Payoh Lorong 7",
  location: {lat: 1.335231459097351, lng: 103.857036007166}
},
{
  id: 11,
  name: "Blk 226D Ang Mo Kio Ave 1",
  location: {lat: 1.366787645236496, lng: 103.8392313440662}
},
{
  id: 12,
  name: "Blk 226H Ang Mo Kio Street 22",
  location: {lat: 1.367230148796791, lng: 103.8399531659365}
},
{
  id: 13,
  name: "Blk 254 Jurong East Street 24",
  location: {lat: 1.343442137710364, lng: 103.7377812314854}
},
{
  id: 14,
  name: "Blk 320 Shunfu Road",
  location: {lat: 1.352007441984509, lng: 103.8370318038227}
},
{
  id: 15,
  name: "Blk 341 Ang Mo Kio Ave 1",
  location: {lat: 1.364105170964155, lng: 103.8482542204378}
},
{
  id: 16,
  name: "Blk 44 Holland Drive",
  location: {lat: 1.308117759099178, lng: 103.7927737654627}
},
{
  id: 17,
  name: "Blk 448 Clementi Ave 3",
  location: {lat: 1.313264869942006, lng: 103.7645105330777}
},
{
  id: 18,
  name: "Blk 49 Sims Place",
  location: {lat: 1.317083351091852, lng: 103.8794170306733}
},
{
  id: 19,
  name: "Blk 4A Eunos Crescent",
  location: {lat: 1.320331782215025, lng: 103.9042608789893}
},
{
  id: 20,
  name: "Blk 4A Jalan Batu",
  location: {lat: 1.302418813535519, lng: 103.8839405802204}
},
{
  id: 21,
  name: "Blk 4A Woodlands Centre Road",
  location: {lat: 1.440840074758661, lng: 103.770087430227}
},
{
  id: 22,
  name: "Blk 502 West Coast Drive",
  location: {lat: 1.311889721159867, lng: 103.7591660938583}
},
{
  id: 23,
  name: "Yishun Hawker Centre",
  location: {lat: 1.425017638031965, lng: 103.8447475818606}
},
{
  id: 24,
  name: "Jurong West Hawker Centre and Market",
  location: {lat: 1.341259706009987, lng: 103.6974042544675}
},
{
  id: 25,
  name: "Pasir Ris Central Hawker Centre",
  location: {lat: 1.373434139732497, lng: 103.9515430347822}
},
{
  id: 26,
  name: "Bukit Panjang Hawker Centre and Market",
  location: {lat: 1.377600535286086, lng: 103.7724895832059}
},
{
  id: 27,
  name: "Blks 13/14 Haig Road",
  location: {lat: 1.315142050528052, lng: 103.8956094948552}
},
{
  id: 28,
  name: "Blks 160/162 Ang Mo Kio Ave 4",
  location: {lat: 1.374489121019108, lng: 103.8392142900382}
},
{
  id: 29,
  name: "Commonwealth Crescent Market",
  location: {lat: 1.30689227608537, lng: 103.8003628255165}
},
{
  id: 30,
  name: "Blk 36 Telok Blangah Rise",
  location: {lat: 1.272715797166533, lng: 103.8221172565801}
},
{
  id: 31,
  name: "Golden Mile Food Centre",
  location: {lat: 1.302875480908837, lng: 103.8638832499849}
},
{
  id: 32,
  name: "Kovan Market & Food Centre",
  location: {lat: 1.359119422126659, lng: 103.8859776169031}
},
{
  id: 33,
  name: "Blk 105 Hougang Ave 1",
  location: {lat: 1.353837391011999, lng: 103.8900810649534}
},
{
  id: 34,
  name: "Blk 112 Jalan Bukit Merah",
  location: {lat: 1.280004811990156, lng: 103.8260132857154}
},
{
  id: 35,
  name: "Blk 115 Bukit Merah View",
  location: {lat: 1.285504783147449, lng: 103.8220493612915}
},
{
  id: 36,
  name: "Pek Kio Market & Food Centre",
  location: {lat: 1.316159913746725, lng: 103.8502250810309}
},
{
  id: 37,
  name: "Sembawang Hills Food Centre",
  location: {lat: 1.372384940021497, lng: 103.8289942043425}
},
{
  id: 38,
  name: "Blk 79 Telok Blangah Drive",
  location: {lat: 1.273368282504294, lng: 103.8076268389537}
},
{
  id: 39,
  name: "Blk 80 Circuit Road",
  location: {lat: 1.327849561426155, lng: 103.8871285351375}
},
{
  id: 40,
  name: "Blk 82 Telok Blangah Drive",
  location: {lat: 1.273913798571447, lng: 103.8079435674162}
},
{
  id: 41,
  name: "Blk 17 Upper Boon Keng Road",
  location: {lat: 1.315028044296041, lng: 103.871620273635}
},
{
  id: 42,
  name: "Blk 29 Bendemeer Road",
  location: {lat: 1.319216997868868, lng: 103.8630213775312}
},
{
  id: 43,
  name: "Blk 347 Jurong East Ave 1",
  location: {lat: 1.345312470268363, lng: 103.7315797471325}
},
{
  id: 44,
  name: "Blk 353 Clementi Ave 2",
  location: {lat: 1.314367728394138, lng: 103.770836740843}
},
{
  id: 45,
  name: "Blk 37A Teban Gardens Road",
  location: {lat: 1.320848350417317, lng: 103.7428916236812}
},
{
  id: 46,
  name: "Blk 409 Ang Mo Kio Ave 10",
  location: {lat: 1.362768917774014, lng: 103.8553697900452}
},
{
  id: 47,
  name: "Blk 453A Ang Mo Kio Ave 10",
  location: {lat: 1.368240493100164, lng: 103.8563514374139}
},
{
  id: 48,
  name: "Blk 69 Geylang Bahru",
  location: {lat: 1.321462260270946, lng: 103.8700044151517}
},
{
  id: 49,
  name: "Blk 527 Ang Mo Kio Ave 10",
  location: {lat: 1.372769928169028, lng: 103.8544828115909}
},
{
  id: 50,
  name: "Blk 538 Bedok North Street 3",
  location: {lat: 1.331781251233144, lng: 103.924844235398}
},
{
  id: 51,
  name: "Blk 58 New Upper Changi Road",
  location: {lat: 1.324187828179919, lng: 103.9411323726195}
},
{
  id: 52,
  name: "Blk 6 Tanjong Pagar Plaza",
  location: {lat: 1.276614610664608, lng: 103.8431669921379}
},
{
  id: 53,
  name: "Blk 628 Ang Mo Kio Ave 4",
  location: {lat: 1.381024866705405, lng: 103.8406823072969}
},
{
  id: 54,
  name: "Blk 630 Bedok Reservoir Road",
  location: {lat: 1.333159247774031, lng: 103.91405388831}
},
{
  id: 55,
  name: "Blk 7 Empress Road",
  location: {lat: 1.316245731184568, lng: 103.8056363868208}
},
{
  id: 56,
  name: "Blk 724 Ang Mo Kio Ave 6",
  location: {lat: 1.372197432700498, lng: 103.8465192192675}
},
{
  id: 57,
  name: "Blk 726 Clementi West Street 2",
  location: {lat: 1.303781972672111, lng: 103.7642644102927}
},
{
  id: 58,
  name: "Blk 74 Toa Payoh Lorong 4",
  location: {lat: 1.334548164956956, lng: 103.8519991375271}
},
{
  id: 59,
  name: "Market Street Food Centre",
  location: {lat: 1.283867038963466, lng: 103.850028715295}
},
{
  id: 60,
  name: "Maxwell Food Centre",
  location: {lat: 1.280112235133393, lng: 103.8448278631226}
},
{
  id: 61,
  name: "Newton Food Centre",
  location: {lat: 1.311892356917424, lng: 103.8395626876442}
},
{
  id: 62,
  name: "North Bridge Road Market & Food Centre",
  location: {lat: 1.305765378028591, lng: 103.8638910123375}
},
{
  id: 63,
  name: "Pasir Panjang Food Centre",
  location: {lat: 1.275907524503414, lng: 103.7914026605528}
},
{
  id: 64,
  name: "Serangoon Garden Market",
  location: {lat: 1.363157120111484, lng: 103.8667374846459}
},
{
  id: 65,
  name: "Taman Jurong Market & Food Centre",
  location: {lat: 1.334589359511337, lng: 103.7215198686294}
},
{
  id: 66,
  name: "Blks 20/21 Marsiling Lane",
  location: {lat: 1.443881816955153, lng: 103.7772031657017}
},
{
  id: 67,
  name: "Blks 221A/B Boon Lay Place",
  location: {lat: 1.345223162797127, lng: 103.7127997658717}
},
{
  id: 68,
  name: "Blks 22A/B Havelock Road",
  location: {lat: 1.287975439988563, lng: 103.8296268346373}
},
{
  id: 69,
  name: "Blks 79/79A Circuit Road",
  location: {lat: 1.326449921673009, lng: 103.8850435000187}
},
{
  id: 70,
  name: "Blks 91/92 Whampoa Drive",
  location: {lat: 1.323421751438994, lng: 103.8540680628599}
},
{
  id: 71,
  name: "Bukit Timah Market",
  location: {lat: 1.339375963515744, lng: 103.7759950080124}
},
{
  id: 72,
  name: "Chong Pang Market & Food Centre",
  location: {lat: 1.431447688311437, lng: 103.8285376099418}
},
{
  id: 73,
  name: "Geylang Serai Market",
  location: {lat: 1.316728147699135, lng: 103.8982243158814}
},
{
  id: 74,
  name: "Holland Village Market & Food Centre",
  location: {lat: 1.31090802808649, lng: 103.7948629361271}
},
{
  id: 75,
  name: "Hong Lim Market & Food Centre",
  location: {lat: 1.285246400471752, lng: 103.8458188855849}
},
{
  id: 76,
  name: "Kallang Estate Market",
  location: {lat: 1.307396160100385, lng: 103.8841301833151}
},
{
  id: 77,
  name: "Blks 2 & 3 Changi Village Road",
  location: {lat: 1.389151720649878, lng: 103.9882457491028}
},
{
  id: 78,
  name: "ABC Brickworks Market & Food Centre",
  location: {lat: 1.286952751990693, lng: 103.8081279993177}
},
{
  id: 79,
  name: "Adam Food Centre",
  location: {lat: 1.324134222533905, lng: 103.8141650103842}
},
{
  id: 80,
  name: "Albert Centre Market & Food Centre",
  location: {lat: 1.301001465215107, lng: 103.8542116454986}
},
{
  id: 81,
  name: "Alexandra Village Food Centre",
  location: {lat: 1.286297772217849, lng: 103.8044892777787}
},
{
  id: 82,
  name: "Amoy Street Food Centre",
  location: {lat: 1.279218442634043, lng: 103.8466067840919}
},
{
  id: 83,
  name: "Bedok Food Centre",
  location: {lat: 1.320356007655045, lng: 103.9554741506773}
},
{
  id: 84,
  name: "Beo Crescent Market",
  location: {lat: 1.288822102053341, lng: 103.8273580171973}
},
{
  id: 85,
  name: "Berseh Food Centre",
  location: {lat: 1.307336516516135, lng: 103.8568539666166}
},
{
  id: 86,
  name: "Blk 1 Jalan Kukoh",
  location: {lat: 1.28823055540125, lng: 103.8399459471859}
},
{
  id: 87,
  name: "Blk 11 Telok Blangah Crescent",
  location: {lat: 1.277366838104559, lng: 103.8186416951064}
},
{
  id: 88,
  name: "Blk 117 Aljunied Ave 2",
  location: {lat: 1.320648292350643, lng: 103.8870190261099}
},
{
  id: 89,
  name: "Blk 127 Toa Payoh Lorong 1",
  location: {lat: 1.338092685514388, lng: 103.8447316219605}
},
{
  id: 90,
  name: "Blk 137 Tampines Street 11",
  location: {lat: 1.345639521023323, lng: 103.9446244811509}
},
{
  id: 91,
  name: "Blk 503 West Coast Drive",
  location: {lat: 1.311803010042863, lng: 103.7597513210194}
},
{
  id: 92,
  name: "Blk 50A Marine Terrace",
  location: {lat: 1.30577514781207, lng: 103.9157619505574}
},
{
  id: 93,
  name: "Blk 51 Old Airport Road",
  location: {lat: 1.308251563098927, lng: 103.8858332177273}
},
{
  id: 94,
  name: "Blk 511 Bedok North Street 3",
  location: {lat: 1.333246278689972, lng: 103.9306021444689}
},
{
  id: 95,
  name: "Tanglin Halt Market",
  location: {lat: 1.300789314809469, lng: 103.7976257567377}
},
{
  id: 96,
  name: "Tekka Market",
  location: {lat: 1.306205840908306, lng: 103.8505309696237}
},
{
  id: 97,
  name: "Zion Riverside Food Centre",
  location: {lat: 1.292342167580749, lng: 103.8311893035464}
},
{
  id: 98,
  name: "Blk 75 Toa Payoh Lorong 5",
  location: {lat: 1.336038821571187, lng: 103.8529415562754}
},
{
  id: 99,
  name: "Blk 79 Redhill Lane",
  location: {lat: 1.28785810256754, lng: 103.818402623449}
},
{
  id: 100,
  name: "Blk 85 Bedok North Street 4",
  location: {lat: 1.331987068618088, lng: 103.9387325805543}
},
{
  id: 101,
  name: "Blk 85 Redhill Lane",
  location: {lat: 1.287330767041112, lng: 103.8183389199937}
},
{
  id: 102,
  name: "Blk 89 Circuit Road",
  location: {lat: 1.323445253339209, lng: 103.885449224256}
},
{
  id: 103,
  name: "Blk 90 Whampoa Drive",
  location: {lat: 1.322943062042634, lng: 103.8551376965354}
},
{
  id: 104,
  name: "Blk 93 Toa Payoh Lorong 4",
  location: {lat: 1.338474752462226, lng: 103.8495134840351}
},
{
  id: 105,
  name: "Blks 1A/ 2A/ 3A Commonwealth Drive",
  location: {lat: 1.299713305319906, lng: 103.7978754774392}
},
{
  id: 106,
  name: "Ci Yuan Hawker Centre",
  location: {lat: 1.37542896666562, lng: 103.8829779993966}
},
{
  id: 107,
  name: "Our Tampines Hub Hawker Centre",
  location: {lat: 1.353862117733181, lng: 103.9397261600388}
},
{
  id: 108,
  name: "Kampung Admiralty Hawker Centre",
  location: {lat: 1.439932832280446, lng: 103.8006964485289}
},
{
  id: 109,
  name: "Dawson Hawker Centre",
  location: {lat: 1.297485671067965, lng: 103.8047152252854}
},
{
  id: 110,
  name: "Woodlands Street 12 Hawker Centre",
  location: {lat: 1.433538856799564, lng: 103.7797848999963}
},
{
  id: 111,
  name: "Blk 163 Bukit Merah Central",
  location: {lat: 1.283692589282146, lng: 103.8169923902946}
},
{
  id: 112,
  name: "Blk 216 Bedok North Street 1",
  location: {lat: 1.327062408890356, lng: 103.9332215447509}
},
{
  id: 113,
  name: "Blk 505 Jurong West Street 52",
  location: {lat: 1.349642243184705, lng: 103.7184475436297}
},
{
  id: 114,
  name: "Blk 159 Mei Chin Road",
  location: {lat: 1.293236220907736, lng: 103.8029039011155}
},
{
  id: 115,
  name: "Blk 16 Bedok South Road",
  location: {lat: 1.320552164810346, lng: 103.9355390963504}
}];


var favourites = [
    {
        dish: {
            name: "Chicken Rice",
            id: 1
        },
        location: {
            center: {
                name: "Sembawang Hills Food Centre",
                id: 1
            },
            stall: {
                name: "#08-09",
                id: 1,
            }
        }
    },
    {
        dish: {
            name: "Chicken Biryani",
            id: 2
        },
        location: {
            center: {
                name: "Geylang Serai Market",
                id: 2
            },
            stall: {
                name: "#00-09",
                id: 3,
            }
        }
    },
    {
        dish: {
            name: "Pig Organ Soup",
            id: 3
        },
        location: {
            center: {
                name: "Sembawang Hills Food Centre",
                id: 1
            },
            stall: {
                name: "#02-01",
                id: 3,
            }
        }
    }
];


var Favourite = function(data){
    this.category = ko.observable(data.category);
    this.center = ko.observable(data.center);
    this.stall = ko.observable(data.stall);
}

var Center = function(data){
    this.name = ko.observable(data.name);
    this.id = ko.observable(data.id);
}

var categories = ['Chicken Porridge', 'Fish Porridge', 'Chicken Rice', 'Carrot Cake', 'Wanton Mee', 'Curry Fish Head', 'Bak Chor Mee', 'Hokkien Prawn Mee', 'Satay Bee Hoon', 'Satay', 'Tau Huay', 'Ice Kacang', 'Chwee Kway', 'Nasi Lemak', 'Mee Siam', 'Mee Rebus', 'Lontong', 'Roti Prata', 'Rojak', 'Duck Rice', 'Char Kway Teow', 'Curry Puff', 'Popiah', 'Char Siew Rice', 'Bak Kut Teh', 'Yong Tau Foo', 'Chicken Biryani', 'Mutton Biryani', 'Laksa', 'Pig Organ Soup'];

var ViewModel = function(){
    var self = this;
    // track which view model should be shown on screen
    this.route = ko.observable();

    this.categories = ko.observableArray(categories);

    this.stallError = ko.observable(false);
    this.favouriteSearch = ko.observable();
    this.categorySearch = ko.observable();

    this.favList = ko.observableArray([]);
    this.centers = ko.observableArray([]);

    favourites.forEach(function(favourite){
        self.favList.push(new Favourite({category: favourite.dish.name, center: favourite.location.center.name, stall: favourite.location.stall.name}));
    });

    centers.forEach(function(center){
        self.centers.push(new Center(center));
    });
    self.centers(centers.sort(function(a,b){if(a.name < b.name){return -1}else if(a.name > b.name){return 1} else {return 0}}));


    this.editing = ko.observable();
    this.adding = ko.observable();

    this.exitFavourites = function(){
        this.route(null);
    };

    this.editFavourites = function(){
        this.route('favourites');
    };

    this.stopPropagation = function(data, event){
        event.stopPropagation();
    };

    this.resetStall = function(favourite){
        favourite.stall(null);
    };

    this.cancelAdd = function(){
        self.adding(null);
    };

    this.addItem = function(item){
        self.favList.push(item);
        self.adding(null);
    };

    this.addNew = function(){
        self.adding(new Favourite({category: null, center: null, stall: null}));
    };

    this.addCategory = function(category){
        self.adding(new Favourite({category: null, center: null, stall: null}));
        self.adding().category(category);
    };

    this.categoryTemplate = function(category){
        return self.adding() && category == self.adding().category() ? 'adding-item' : 'category-item';
    };

    this.toggleEditing = function(favourite){
        if (!self.editing() || self.editing().stall()){
            if (self.editing() == favourite){
                    self.editing(null);
            } else {
                self.editing(favourite);
            }
        } else {
            self.stallError(true);
        }
    };

    this.changeFav = function(favourite, event){
        favourite.center()
    };

    this.searchResults = ko.computed(function(){
        var searchTerm = new RegExp(self.favouriteSearch(), 'ig');
        return self.favList().filter(function(d){
            return d.category().match(searchTerm);
        }).sort(function(a, b){
            if(a.category() < b.category()){
                return -1;
            }
            if(a.category() > b.category()){
                return 1;
            }
            return 0;
        });
    });

    this.clearSelected = function(){
        if(self.adding()){
            self.adding().category(null);
        }
    };

    this.categorySearchResults = ko.computed(function(){
        if(self.adding()){
            // self.adding().category(null);
        };
        var existing = self.favList().map(function(d){return d.category()});

        var searchTerm = new RegExp(self.categorySearch(), 'ig');
        return self.categories().filter(function(d){
            return d.match(searchTerm) && $.inArray(d, existing)==-1;
        }).sort();
    });
}

ko.applyBindings(new ViewModel());
