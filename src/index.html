<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Neighbourhood Map</title>
        <link rel="stylesheet" href="css/vendor/normalize.css">
        <link rel="stylesheet" href="css/main.css">
    </head>
    <body>
        <section class="c-section">
            <div id="map" class="c-map"></div>
            <main class="c-main h-container">
            <div class="c-top-bar">
                <div class="c-top-bar__container h-container">
                    <h1 class="c-top-bar__title">Hawker</h1>
                    <input placeholder="Search for your hawker favourites" class="c-top-bar__input c-top-bar__search" list="dish-search" type="text" data-bind="textInput: generalSearch" />
                    <datalist id="dish-search" data-bind="foreach: $root.dishes">
                        <option data-bind="value: $data">
                    </datalist>
                    <input min="1" class="c-top-bar__input c-top-bar__input--small" type="number" id="rankingFilter" data-bind="textInput: filterRanking"></input>
                    <span data-bind="click: editFavourites" class="c-button">View/edit favourites</span>
                </div>
                <div class="c-top-bar__container h-container">
                    <span class="c-message-list__message" data-bind="visible: filterMessage, html: filterMessage"></span>
                    <h3 data-bind="text: generalSearch, visible: dishRankings().length > 0"></h3>
                    <ul class="c-ranking-list" data-bind="foreach: dishRankings">
                        <li data-bind="if: $data">
                            <span class="c-ranking-list__group-title" data-bind="text: 'Ranking: ' + ($index())"></span>
                            <ul data-bind="foreach: $data">
                                <li data-bind="text: name, click: function(){$root.moreInfo(id)}"></li>
                            </ul>
                        </li>
                    </ul>
                    </div>
                </div>
            <img class="c-loading-icon" id="centres-loading-icon" src="img/Ripple.svg" />
            </main>
        </section>
        <div class="c-modal-container c-modal-container--overlay" data-bind="visible: viewing, with: viewing">
            <div class="c-modal c-modal--wide">
                <div class="c-modal__above">
                    <i class="fa fa-times c-modal__close-btn" data-bind="click: $root.clearViewing"></i>
                </div>
                <div class="c-modal__main c-hawker-details">
                    <div class="c-hawker-details__left">
                        <h2 class="c-hawker-details__title" data-bind="text: name"></h2>
                        <span data-bind="text: streetno"></span>
                        <span data-bind="text: streetname"></span>
                        <span data-bind="text: postalcode"></span>
                        <div data-bind="foreach: $root.foursquareImages().slice(0,5)">
                            <img data-bind="attr: {src: prefix + '300x300' + suffix}" class="c-hawker-details__image"/>
                        </div>
                        <h3 class="c-hawker-details__subtitle" data-bind="visible: rankings.length">Rankings</h3>
                        <input min="1" data-bind="visible: rankings.length, textInput: $root.inMoreInfoLimit" type="number">
                        <select data-bind="options: $root.rankFilterOptions, value: $root.inMoreInfoLimit"></select>
                        <ul class="c-hawker-details__ranking-list" data-bind="foreach: rankings">
                            <li data-bind="visible: parseInt(rank) <= ($root.inMoreInfoLimit() || 5), attr: { class: 'c-hawker-details__ranking-item c-hawker-details__ranking-item--' + rank }">
                                <span class="c-hawker-details__item-rank" data-bind="text: rank"></span>
                                <span class="c-hawker-details__item-name" data-bind="text: dish_name"></span>
                            </li>
                        </ul>
                        <p data-bind="html: '<a class=\'c-button\' target=\'_blank\' href=\'' + $root.foursquareUrl() + '\'>View on Foursquare</a>'"></p>
                    </div>
                    <div class="c-hawker-details__right">
                        <h3>Tips from Foursquare:</h3>
                        <ul class="c-foursquare__list c-list" data-bind="foreach: $root.foursquareTips">
                            <li class="c-foursquare__tip">
                                <span class="c-foursquare__tip-body" data-bind="text: text"></span>
                                <span class="c-foursquare__tip-likes" data-bind="html: '<i class=\'fa fa-thumbs-up\'></i> ' + likes.count"></span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="c-modal-container c-modal-container--overlay" data-bind="visible: route() == 'favourites'">
            <div class="c-modal">
                <div class="c-modal__above">
                    <i class="fa fa-times c-modal__close-btn" data-bind="click: exitFavourites"></i>
                </div>
                <div class="c-modal__main c-favourites">
                    <div class="c-list" data-bind="visible: !adding(), template: 'favourite-template'"></div>
                    <div class="c-list" data-bind="visible: adding(), template: 'adding-new-template'"></div>
                </div>
            </div>
        </div>

        <script type="text/html" id="favourite-template">
            <div class="c-list__header">
                <h2 class="c-favourites__heading">My Favourites</h2>
                <input placeholder="Search" class="c-favourites__search" type="text" data-bind="textInput: favouriteSearch" />
            </div>
            <!-- <div class="c-list__main" data-bind="template: {name: 'favourite-item', foreach: searchResults}"></div> -->
            <div class="c-list__main" data-bind="foreach: favouritesList">
                <div data-bind="template: {if: centre(), name: 'favourite-item-defined'}"></div>
                <div data-bind="template: {if: !centre(), name: 'favourite-item-undefined'}"></div>
            </div>
        </script>
        <script type="text/html" id="adding-new-template">
            <div class="c-list__header">
                <h2 class="c-favourites__heading">Add a New Favourite</h2>
                <input placeholder="Search" class="c-favourites__search" type="text" data-bind="textInput: categorySearch, event: {keyup: $root.clearSelected}" />
            </div>
            <span data-bind="visible: categorySearchResults().length == 0">HELLO</span>
            <div class="c-list__main" data-bind="template: {name: categoryTemplate, foreach: categorySearchResults}"></div>
        </script>
        <script type="text/html" id="category-item">
            <div data-bind="click: $parent.addCategory" class="c-list__item c-category__item">
                <div class="c-favourite__details">
                    <span class="c-favourite__category" data-bind="text: name"></span>
                </div>
            </div>
        </script>
        <script type="text/html" id="adding-item">
            <div class="c-list__item c-favourite" data-bind="with: $root.adding()">
                <div class="c-favourite__details">
                    <span class="c-favourite__category" data-bind="text: dish_name, visible: !dish_name()"></span>
                    <h4>Which hawker centre has the best <span data-bind="text: dish_name"></span>?</h4>
                    <span class="c-favourite__choice">
                        <select data-bind="optionsCaption: 'Select a hawker centre...', options: $root.centers, optionsText: 'name', optionsValue: 'id', value: centerId"></select>
                    </span>
                </div>
                <div class="c-favourite__actions">
                    <a data-bind="click: $root.addItem" class="c-favourite__action c-favourite__action--add" href="#"><i class="fa fa-check"></i></a>
                    <a data-bind="click: $root.cancelAdd" class="c-favourite__action c-favourite__action--delete" href="#"><i class="fa fa-times"></i></a>
                </div>
            </div>
        </script>
        <script type="text/html" id="favourite-item-defined">
            <div class="c-list__item c-favourite" data-bind="css: {'c-favourite--defined': $data.centre(), 'c-favourite--editing': $data == $parent.editing()}">
                <div class="c-favourite__details">
                    <span data-bind="text: dish_name" class="c-favourite__category"></span>
                    <span class="c-favourite__choice">
                        <select data-bind="optionsCaption: 'Select a hawker centre...', options: $root.centers, optionsText: 'name', valueAllowUnset: true, value: centre, visible: $data == $parent.editing()"></select>
                        <span data-bind="click: function(){console.log($data.centre().id); $root.moreInfo($data.centre().id)}, text: $data.centre().name, visible: $data != $parent.editing()" class="c-favourite__centre-name"></span>
                    </span>
                </div>
                <div class="c-favourite__actions">
                    <a data-bind="click: $parent.toggleEditing" class="c-favourite__action c-favourite__action--edit" href="#"><i data-bind="css: {'fa-pencil': $data != $parent.editing(), 'fa-check': $data == $parent.editing()}"class="fa"></i></a>
                    <a data-bind="click: $parent.deleteItem" class="c-favourite__action c-favourite__action--delete" href="#"><i class="fa fa-trash-o"></i></a>
                </div>
            </div>
        </script>
        <script type="text/html" id="favourite-item-undefined">
            <div class="c-list__item c-favourite" data-bind="click: $parent.toggleEditing, css: {'c-favourite--editing': $data == $parent.editing()}">
                <div class="c-favourite__details">
                    <span data-bind="text: dish_name" class="c-favourite__category"></span>
                    <span class="c-favourite__choice">
                        <select data-bind="optionsCaption: 'Select a hawker centre...', options: $root.centers, optionsText: 'name', valueAllowUnset: true, value: centre, visible: $data == $parent.editing()"></select>
                        <span data-bind="visible: $data != $parent.editing()" class="c-favourite__placeholder">Add a favourite</span>
                    </span>
                </div>
                <div class="c-favourite__actions">
                    <a class="c-favourite__action c-favourite__action--edit" href="#"><i class="fa fa-plus"></i></a>
                </div>
            </div>
        </script>
        <script src="js/vendor/jquery.min.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-firestore.js"></script>
        <script src="js/vendor/sammy-latest.min.js"></script> -->
        <script src="js/vendor/knockout.js"></script>
        <script>var vm; var test;</script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHBvf6-JlN0Svg5kpADRsuo7bFPWj1wt0&callback=initMap&v=3">
        </script>
        <script>
            var map;
            var mapStyles = [
                {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#e9e9e9"
                    },
                    {
                        "lightness": 17
                    }
                ]
                },
                {
                "featureType": "landscape",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f5f5f5"
                    },
                    {
                        "lightness": 20
                    }
                ]
                },
                {
                "featureType": "road.highway",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 17
                    }
                ]
                },
                {
                "featureType": "road.highway",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 29
                    },
                    {
                        "weight": 0.2
                    }
                ]
                },
                {
                "featureType": "road.arterial",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 18
                    }
                ]
                },
                {
                "featureType": "road.local",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 16
                    }
                ]
                },
                {
                "featureType": "poi",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f5f5f5"
                    },
                    {
                        "lightness": 21
                    }
                ]
                },
                {
                "featureType": "poi.park",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#dedede"
                    },
                    {
                        "lightness": 21
                    }
                ]
                },
                {
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "visibility": "on"
                    },
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 16
                    }
                ]
                },
                {
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "saturation": 36
                    },
                    {
                        "color": "#333333"
                    },
                    {
                        "lightness": 40
                    }
                ]
                },
                {
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
                },
                {
                "featureType": "transit",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f2f2f2"
                    },
                    {
                        "lightness": 19
                    }
                ]
                },
                {
                "featureType": "administrative",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#fefefe"
                    },
                    {
                        "lightness": 20
                    }
                ]
                },
                {
                "featureType": "administrative",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#fefefe"
                    },
                    {
                        "lightness": 17
                    },
                    {
                        "weight": 1.2
                    }
                ]
                }
            ]

            var markers = [];

            // to do: add data layer so that vm can update markers

            function initMap(){
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 1.3521, lng: 103.8198},
                    zoom: 12,
                    mapTypeControl: false,
                    styles: mapStyles,
                });

                // var infoWindow = new google.maps.InfoWindow({});
                //
                // infoWindow.addListener('closeclick', function(){
                //     vm.clearViewing();
                // });
                //
                // $.ajax({
                //     'url': 'http://andreacrawford.design/hawkerdb/centres/',
                //     'success': function(data){
                //         for(var key in data){
                //             var marker = new google.maps.Marker({
                //                 position: {lng:parseFloat(data[key]['lng']), lat:parseFloat(data[key]['lat'])},
                //                 map: map,
                //             });
                //
                //             marker.addListener('click', (function(thisMarker, thisInfo){
                //                 var rankingHTML = '';
                //                 if(thisInfo.rankings.length > 0){
                //                     rankingHTML += '<hr/>';
                //                     for(var i = 0; i<thisInfo.rankings.length && i<3; i++){
                //                         rankingHTML += '<i class="fa fa-certificate c-ranking--' + thisInfo.rankings[i].rank + '"></i> <strong>#' + thisInfo.rankings[i].rank + '</strong> for ' + thisInfo.rankings[i].dish_name + '</br>';
                //                     };
                //                     if(thisInfo.rankings.length > 3){
                //                         rankingHTML += 'And '+ (thisInfo.rankings.length - 3) +' more&hellip;';
                //                     };
                //                 }
                //                 return function(){
                //                     // console.log(vm.editing());
                //                     // console.log('asdasdasd');
                //                     vm.changeViewing(thisInfo.id);
                //                     thisMarker.setAnimation(google.maps.Animation.DROP);
                //                     infoWindow.setContent('<div id="info-window" data-bind="click: function(){moreInfo(' + thisInfo.id + ')}" class="c-infowindow"><h4>' + thisInfo.name + '</h4>'+
                //                         rankingHTML +
                //                         '</div>');
                //                     infoWindow.open(map, thisMarker);
                //                     ko.applyBindings(vm, document.getElementById('info-window'));
                //                 }
                //             })(marker, data[key]))
                //         }
                //         $('#centres-loading-icon').hide();
                //     },
                // })


            }
        </script>
        <script src="js/app.js"></script>
        <!-- <script src="js/data.js"></script> -->
    </body>
</html>
