<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Neighbourhood Map</title>
        <link rel="stylesheet" href="css/vendor/normalize.css">
        <link rel="stylesheet" href="css/main.css">
    </head>
    <body>
        <div id="map" class="c-map"></div>
        <main>
        <div class="c-top-bar">
            <div class="c-top-bar__container h-container">
                <h1 class="c-top-bar__title">Hawker</h1>
                <span data-bind="click: editFavourites" class="c-button">View/edit favourites</span>
            </div>
        </div>
        <main class="c-main h-container">
        </main>
        <div class="c-modal-container c-modal-container--overlay" data-bind="visible: route() == 'favourites'">
            <div class="c-modal">
                <div class="c-modal__above">
                    <i class="fa fa-times c-modal__close-btn" data-bind="click: exitFavourites"></i>
                </div>
                <div class="c-modal__main">
                    <div class="c-list c-favourites" data-bind="visible: !adding(), template: 'favourite-template'"></div>
                    <div class="c-list c-favourites" data-bind="visible: adding(), template: 'adding-new-template'"></div>
                </div>
                <div class="c-modal__below">
                    <a data-bind="click: addNew, visible: !adding()" href="#" class="c-button c-button--dark">Add a new favourite</a>
                </div>
            </div>
        </div>

        <script type="text/html" id="favourite-template">
            <div class="c-list__header">
                <h2 class="c-favourites__heading">My Favourites</h2>
                <input placeholder="Search" class="c-favourites__search" type="text" data-bind="textInput: favouriteSearch" />
            </div>
            <div class="c-list__main" data-bind="template: {name: 'favourite-item', foreach: searchResults}"></div>
        </script>
        <script type="text/html" id="adding-new-template">
            <div class="c-list__header">
                <h2 class="c-favourites__heading">Add a New Favourite</h2>
                <input placeholder="Search" class="c-favourites__search" type="text" data-bind="textInput: categorySearch, event: {keyup: $root.clearSelected}" />
            </div>
            <div class="c-list__main" data-bind="template: {name: categoryTemplate, foreach: categorySearchResults}"></div>
        </script>
        <script type="text/html" id="category-item">
            <div data-bind="click: $parent.addCategory" class="c-list__item c-category__item">
                <div class="c-favourite__details">
                    <span class="c-favourite__category" data-bind="text: $data"></span>
                </div>
            </div>
        </script>
        <script type="text/html" id="adding-item">
            <div class="c-list__item c-favourite" data-bind="with: $root.adding()">
                <div class="c-favourite__details">
                    <span class="c-favourite__category" data-bind="text: category, visible: !category()"></span>
                    <h3>Which hawker stall has the best <span data-bind="text: category"></span>?</h3>
                    <span class="c-favourite__choice">
                        <select data-bind="optionsCaption: 'Select a hawker centre...', options: $root.centers, optionsValue: 'name', value: center, event: {change: $parent.resetStall}"></select>
                        <input data-bind="textInput: stall, event: {blur: $parent.toggleEditing}" type="text"/>
                    </span>
                </div>
                <div class="c-favourite__actions">
                    <a data-bind="click: $root.addItem" class="c-favourite__action c-favourite__action--add" href="#"><i class="fa fa-check"></i></a>
                    <a data-bind="click: $root.cancelAdd" class="c-favourite__action c-favourite__action--delete" href="#"><i class="fa fa-times"></i></a>
                </div>
            </div>
        </script>
        <script type="text/html" id="favourite-item">
            <div class="c-list__item c-favourite" data-bind="css: {'c-favourite--editing': $data == $parent.editing()}">
                <div class="c-favourite__details">
                    <span data-bind="text: category" class="c-favourite__category"></span>
                    <span class="c-favourite__choice">
                        <select data-bind="optionsCaption: 'Select a hawker centre...', options: $root.centers, optionsValue: 'name', value: center, visible: $data == $parent.editing(), event: {change: $parent.resetStall}"></select>
                        <input data-bind="textInput: stall, visible: $data == $parent.editing(), event: {blur: $parent.toggleEditing}" type="text"/>
                        <span data-bind="text: center, visible: $data != $parent.editing()" class="c-favourite__center-name"></span>
                        <span data-bind="text: stall, visible: $data != $parent.editing()" class="c-favourite__stall-name"></span>
                    </span>
                    <span data-bind="visible: $data == $parent.editing() && $parent.stallError()">Please select a stall</span>
                </div>
                <div class="c-favourite__actions">
                    <a data-bind="click: $parent.toggleEditing" class="c-favourite__action c-favourite__action--edit" href="#"><i class="fa fa-pencil"></i></a>
                    <a data-bind="click: $parent.toggleEditing" class="c-favourite__action c-favourite__action--delete" href="#"><i class="fa fa-trash-o"></i></a>
                </div>
            </div>
        </script>
        <script src="js/vendor/jquery.min.js"></script>
        <script>
        // var data = {
        //   resource_id: '8f6bba57-19fc-4f36-8dcf-c0bda382364d',
        //   limit: 200,
        // };
        // var hawkerCentres;
        // $.ajax({
        //   url: 'https://data.gov.sg/api/action/datastore_search',
        //   data: data,
        //   dataType: 'json',
        //   success: function(data) {
        //     hawkerCentres = data.result.records;
        //     hawkerCentres = hawkerCentres.filter(function(d){
        //         return d.no_of_cooked_food_stalls != 0;
        //     });
        //   }
        // });
</script>
        <script src="js/vendor/sammy-latest.min.js"></script>
        <script src="js/vendor/knockout.js"></script>
        <script src="js/app.js"></script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHBvf6-JlN0Svg5kpADRsuo7bFPWj1wt0&v=3&callback=initMap">
        </script>
        <script>
            var map;
            var mapStyles = [
                {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#e9e9e9"
                    },
                    {
                        "lightness": 17
                    }
                ]
                },
                {
                "featureType": "landscape",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f5f5f5"
                    },
                    {
                        "lightness": 20
                    }
                ]
                },
                {
                "featureType": "road.highway",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 17
                    }
                ]
                },
                {
                "featureType": "road.highway",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 29
                    },
                    {
                        "weight": 0.2
                    }
                ]
                },
                {
                "featureType": "road.arterial",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 18
                    }
                ]
                },
                {
                "featureType": "road.local",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 16
                    }
                ]
                },
                {
                "featureType": "poi",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f5f5f5"
                    },
                    {
                        "lightness": 21
                    }
                ]
                },
                {
                "featureType": "poi.park",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#dedede"
                    },
                    {
                        "lightness": 21
                    }
                ]
                },
                {
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "visibility": "on"
                    },
                    {
                        "color": "#ffffff"
                    },
                    {
                        "lightness": 16
                    }
                ]
                },
                {
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "saturation": 36
                    },
                    {
                        "color": "#333333"
                    },
                    {
                        "lightness": 40
                    }
                ]
                },
                {
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
                },
                {
                "featureType": "transit",
                "elementType": "geometry",
                "stylers": [
                    {
                        "color": "#f2f2f2"
                    },
                    {
                        "lightness": 19
                    }
                ]
                },
                {
                "featureType": "administrative",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#fefefe"
                    },
                    {
                        "lightness": 20
                    }
                ]
                },
                {
                "featureType": "administrative",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#fefefe"
                    },
                    {
                        "lightness": 17
                    },
                    {
                        "weight": 1.2
                    }
                ]
                }
            ]

            var markers = [];

            function initMap(){
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 1.3521, lng: 103.8198},
                    zoom: 12,
                    mapTypeControl: false,
                    styles: mapStyles,
                });

                var infoWindow = new google.maps.InfoWindow({});

                for(var i=0; i<centers.length; i++){
                    var marker = new google.maps.Marker({
                        position: centers[i]['location'],
                        map: map,
                    });

                    marker.addListener('click', (function(thisMarker, thisInfo, index){
                        var ranking = Math.ceil(index/categories.length);
                        return function(){
                            thisMarker.setAnimation(google.maps.Animation.DROP);
                            infoWindow.setContent('<h4>' + thisInfo + '</h4>'+
                                '<hr><i class="fa fa-certificate"></i> ' +
                                '<strong>#'+ranking+'</strong> for ' + categories[index % categories.length]);
                            infoWindow.open(map, thisMarker);
                        }
                    })(marker, centers[i]['name'], i))
                };


            }
        </script>
    </body>
</html>
